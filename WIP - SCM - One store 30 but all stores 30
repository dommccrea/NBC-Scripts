WITH
  -- 1) Build a per-article/DC/store base set with your existing joins
  base_data AS (
    SELECT DISTINCT
      MARA.MATNR                                        AS ArtNr,
      RIGHT(MARA.MATNR, 6)                              AS DisplayID,
      MAKT_EN.MAKTX                                     AS DESCRIPTION_EN,
      CASE 
        WHEN RIGHT(LEFT(MVKE.PRODH,5),1) = '1' THEN 'Core Range'
        WHEN RIGHT(LEFT(MVKE.PRODH,5),1) = '3' THEN 'Seasonal'
        ELSE ''
      END                                               AS PRODUCT_HIERARCHY,
      RIGHT(MARA.MATKL,2) || ' - ' || WRF_MATGRP_MD4T.LTEXT
                                                       AS ASCG,
      MARC.WERKS                                        AS DC,
      DC.FILIA                                          AS DC_LISTING,
      MARC.MMSTA                                        AS DC_STATUS,
      TO_VARCHAR(TO_DATE(DC.DATAB,'YYYYMMDD'),'DD/MM/YYYY')
                                                       AS DC_VALID_FROM,
      TO_VARCHAR(TO_DATE(DC.DATBI,'YYYYMMDD'),'DD/MM/YYYY')
                                                       AS DC_VALID_TILL,
      STORE.FILIA                                       AS STORE_LISTING,
      MARCSTORE.MMSTA                                   AS STORE_STATUS,
      TO_VARCHAR(TO_DATE(STORE.DATAB,'YYYYMMDD'),'DD/MM/YYYY')
                                                       AS STORE_VALID_FROM,
      TO_VARCHAR(TO_DATE(STORE.DATBI,'YYYYMMDD'),'DD/MM/YYYY')
                                                       AS STORE_VALID_TILL
    FROM MARA

      LEFT JOIN WRF_MATGRP_MD4T
        ON WRF_MATGRP_MD4T.NODE = MARA.MATKL
       AND WRF_MATGRP_MD4T.SPRAS = 'E'

      INNER JOIN MVKE
        ON MVKE.MATNR = MARA.MATNR
       AND MVKE.VKORG = '5998'
       AND MVKE.VTWEG = '10'

      INNER JOIN MARC
        ON MARC.MATNR = MARA.MATNR
       AND MARC.WERKS LIKE 'GD%'

      LEFT JOIN WLK1 DC
        ON DC.ARTNR  = MARA.MATNR
       AND DC.DATBI > CURRENT_DATE
       AND DC.FILIA = MARC.WERKS

      LEFT JOIN WLK1 STORE
        ON STORE.ARTNR = MARA.MATNR
       AND STORE.DATBI > CURRENT_DATE
       AND MARC.WERKS = CASE
         WHEN STORE.FILIA LIKE '%MIN-%' AND MARA.TEMPB NOT IN ('9A','8A') THEN 'GD01'
         WHEN STORE.FILIA LIKE '%STP-%' AND LEFT(MARA.MATKL,4) = '0001' THEN 'GD01'
         WHEN STORE.FILIA LIKE '%MIN-%' AND MARA.TEMPB IN ('9A','8A') THEN 'GD21'
         WHEN STORE.FILIA LIKE '%DER-%' AND MARA.TEMPB NOT IN ('9A','8A') THEN 'GD02'
         WHEN STORE.FILIA LIKE '%RGY-%' AND LEFT(MARA.MATKL,4) = '0001' THEN 'GD02'
         WHEN STORE.FILIA LIKE '%DER-%' AND MARA.TEMPB IN ('9A','8A') THEN 'GD22'
         WHEN STORE.FILIA LIKE '%STP-%' AND LEFT(MARA.MATKL,4) <> '0001' THEN 'GD03'
         WHEN STORE.FILIA LIKE '%PRE-%' AND MARA.TEMPB NOT IN ('9A','8A') THEN 'GD04'
         WHEN STORE.FILIA LIKE '%PRE-%' AND MARA.TEMPB IN ('9A','8A') THEN 'GD21'
         WHEN STORE.FILIA LIKE '%DAN-%'                                THEN 'GD05'
         WHEN STORE.FILIA LIKE '%BRE-%'                                THEN 'GD06'
         WHEN STORE.FILIA LIKE '%RGY-%' AND LEFT(MARA.MATKL,4) <> '0001' THEN 'GD07'
         WHEN STORE.FILIA LIKE '%JKT-%'                                THEN 'GD08'
       END
       AND STORE.FILIA NOT LIKE '%000%'

      LEFT JOIN WRSZ
        ON WRSZ.ASORT = STORE.FILIA
       AND WRSZ.DATBI >= CURRENT_DATE

      INNER JOIN MARC MARCSTORE
        ON MARCSTORE.MATNR = MARA.MATNR
       AND MARCSTORE.WERKS  = WRSZ.LOCNR

      LEFT JOIN MAKT MAKT_EN
        ON MAKT_EN.MATNR = MARA.MATNR
       AND MAKT_EN.SPRAS = 'E'

    WHERE
      MARC.MMSTA IN ('20','21','30')
      AND MARCSTORE.MMSTA IS NOT NULL
  ),

  -- 2) Flag per article+DC whether at least one store = 30, and at least one <> 30
  flagged AS (
    SELECT
      bd.*,
      MAX(CASE WHEN STORE_STATUS = '30' THEN 1 ELSE 0 END)
        OVER (PARTITION BY ArtNr, DC)      AS AnyStore30Flag,
      MAX(CASE WHEN STORE_STATUS <> '30' THEN 1 ELSE 0 END)
        OVER (PARTITION BY ArtNr, DC)      AS NotAllStores30Flag
    FROM base_data bd
  )

-- 3) Only keep those article+DC where some stores are 30 but not all
SELECT DISTINCT
  DisplayID,
  DESCRIPTION_EN,
  PRODUCT_HIERARCHY,
  ASCG,
  DC,
  DC_LISTING,
  DC_STATUS,
  DC_VALID_FROM,
  DC_VALID_TILL,
  STORE_LISTING AS STORE,
  STORE_STATUS,
  STORE_VALID_FROM,
  STORE_VALID_TILL
FROM flagged
WHERE AnyStore30Flag    = 1
  AND NotAllStores30Flag = 1
ORDER BY DisplayID;
