WITH
  -- 1) Articles flagged as Special Buy
  SPECIAL_BUY AS (
    SELECT DISTINCT MATNR
      FROM MVKE
     WHERE SUBSTR(PRODH,5,1) = '2'
  ),

  -- 2) Only display articles
  DISPLAY_ARTICLES AS (
    SELECT DISTINCT MATNR
      FROM MARA
     WHERE ATTYP = '12'
  ),

  -- 3) Target articles: Special Buy + Display + Z100 + Merch categories
  TARGET_ARTICLES AS (
    SELECT DISTINCT SB.MATNR AS MATNR,
           M.MATKL                  AS MATKL
      FROM SPECIAL_BUY SB
      JOIN DISPLAY_ARTICLES D ON SB.MATNR = D.MATNR
      JOIN MARA M ON SB.MATNR = M.MATNR
                   AND M.MTART = 'Z100'
     WHERE LPAD(M.MATKL,8,'0') IN (
       '00025701','00025702','00025703','00025704','00025705','00025706','00025707','00025708','00025709','00025710',
       '00025711','00025712','00028901','00028902','00028903','00028904','00028905',
       '00034501','00034502','00034503','00034504','00034505','00034506',
       '00034601','00034602','00034603','00034604','00034605','00034606',
       '00035301','00035302','00035303','00035304','00035305','00035306',
       '00039001','00039002','00039003','00039004',
       '00045001','00045002','00045003','00045004',
       '00077501','00077502','00077503','00077504','00077505','00077506','00077507','00077508','00077509','00077510',
       '00077601','00077602','00077603','00077604',
       '00077701','00077702','00077703',
       '00077801','00077802','00077803','00077804',
       '00082702','00082703','00082704','00082705','00082706','00082707','00082708','00082709','00082710',
       '00094701','00094702','00094703','00094704','00094705','00094706',
       '00094801','00094802','00094803','00094804','00094805',
       '00094901',
       '00095201','00095202','00095203','00095204','00095205','00095206','00095207',
       '00095401','00095402','00095403','00095404','00095405','00095406',
       '00098201','00098202',
       '00100501','00100502',
       '00107901','00107902','00107903',
       '00108001','00108002',
       '00108101','00108102',
       '00114001','00114002','00114003','00114004','00114005',
       '00114101','00114102','00114103','00114104',
       '00114201','00114202','00114303','00114401',
       '00118601','00118602','00118701','00118702',
       '00121201','00121202','00121203','00121204',
       '00122001','00122002','00122003','00122004','00122005','00122006','00122007',
       '00122401','00122402','00122403',
       '00131401','00131402','00131403','00131404','00131405','00131406','00131407','00131408','00131409','00131410','00131411',
       '00131501','00131502','00131503','00131504','00131505','00131506','00131507','00131508','00131509','00131510','00131511',
       '00131601','00131602','00131603','00131604','00131605','00131606','00131607','00131608','00131609','00131610','00131611','00131612',
       '00131701','00131702','00131703','00131704','00131705','00131706','00131707','00131708','00131709',
       '00132101','00132102',
       '00132301','00132302','00132303','00132304','00132305',
       '00133601','00133602','00133603','00133604','00133605','00133606','00133607','00133608',
       '00139101',
       '00140701','00140702','00140703','00140704','00140705','00140706',
       '00140801','00140802','00140803','00140804','00140805','00140806',
       '00140901','00140902','00140903','00140904','00140905','00140906','00140907','00140908',
       '00141301','00141302','00141303','00141304','00141305','00141306',
       '00151801','00151802','00151803','00151804','00151805','00151806','00151807','00151808','00151809',
       '00151901','00151902','00151903','00151904','00151905','00151906','00151907','00151908','00151909',
       '00152201','00152202','00152203','00152204','00152205','00152206','00152207','00152208','00152209','00152210','00152211','00152212','00152213','00152214',
       '00152501','00152502','00152503','00152504','00152505','00152506','00152507','00152508',
       '00152801','00152802','00152803','00152804','00152805','00152806','00152807','00152808','00152809',
       '00152901','00152902','00152903','00152904','00152905','00152906','00152907',
       '00153101','00153102','00153103','00153104','00153105','00153106','00153107','00153108','00153109','00153110',
       '00153501','00153502','00153503','00153504','00153505',
       '00159201','00159202','00159203',
       '00160601','00160602','00160603','00160604','00160605','00160606','00160607','00160608','00160609',
       '00161001','00161002','00161003','00161004',
       '00161101','00161102','00161103','00161104',
       '00163901','00163902','00163903','00163904','00163905','00163906','00163907',
       '00166101',
       '00168501','00168502','00168503','00168505','00168506',
       '00173001','00173002','00173003','00173004','00173005',
       '00173201','00173202','00173203','00173204','00173205','00173206','00173207','00173208','00173209','00173210','00173211','00173212','00173213','00173214',
       '00173301','00173302','00173303','00173304',
       '00173401','00173402','00173403','00173404','00173405',
       '00173701','00173702','00173703','00173704','00173705','00173706','00173707'
     )
  ),

  -- 4) Home DC listing details
  HOME_LISTINGS AS (
    SELECT DISTINCT
      L.ARTNR        AS MATNR,
      L.FILIA        AS HOME_DC,
      M.MMSTA        AS HOME_DC_STATUS,
      L.DATAB        AS HOME_LIST_FROM,
      L.DATBI        AS HOME_LIST_TO
    FROM WLK1 L
    JOIN MARC M ON M.MATNR = L.ARTNR
                AND M.WERKS = L.FILIA
    WHERE L.FILIA IN ('GD01','GD04','GD02','GD05')
      AND L.DATBI > CURRENT_DATE
  )

-- 5) Final report
SELECT DISTINCT
  T.MATNR                         AS Article,
  MAKT.MAKTX                      AS Description,
  LPAD(T.MATKL,8,'0')            AS Merch_Category,
H.HOME_DC,
  H.HOME_DC_STATUS,
  H.HOME_LIST_FROM,
  H.HOME_LIST_TO,
  WAKH.AKTNR                      AS Promotion_ID,
  WAKH.VKDAB                      AS OnSale_Date,
  WAKP.ARTNR                      AS Display_ID
FROM TARGET_ARTICLES T
JOIN HOME_LISTINGS H   ON T.MATNR    = H.MATNR
LEFT JOIN MAKT        ON MAKT.MATNR  = T.MATNR
LEFT JOIN WAKP        ON WAKP.ARTNR  = T.MATNR
LEFT JOIN WAKH        ON WAKH.AKTNR  = WAKP.AKTNR
JOIN MARA M2          ON M2.MATNR    = T.MATNR
WHERE WAKH.VKDAB >= CURRENT_DATE
ORDER BY T.MATNR;
