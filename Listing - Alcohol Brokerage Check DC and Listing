WITH STORE_LISTINGS AS (
  SELECT
    WLK.ARTNR                                             AS ARTNR,
    RIGHT(MARC1.MATNR,6)                                  AS DISPLAY,
    MAKT.MAKTX                                            AS DESCRIPTION,
    WRSZ.LOCNR                                            AS STORE,
    MARC1.MMSTA                                           AS STORE_STATUS,
    WLK.FILIA                                             AS STORE_LISTING,
    WLK.DATAB                                             AS SL_VALID_FROM,
    WLK.DATBI                                             AS SL_VALID_TO,
    ROW_NUMBER() OVER (
      PARTITION BY WLK.ARTNR, WRSZ.LOCNR
      ORDER BY WLK.DATAB DESC
    )                                                      AS RN,
    DC01.MMSTA                                            AS GD01_STATUS,
    DC02.MMSTA                                            AS GD02_STATUS,
    DC03.MMSTA                                            AS GD03_STATUS,
    DC07.MMSTA                                            AS GD07_STATUS
  FROM WRSZ
  JOIN WLK1 AS WLK
    ON WLK.FILIA = WRSZ.ASORT
  JOIN MARA
    ON MARA.MATNR = WLK.ARTNR
  JOIN MARC AS MARC1
    ON MARC1.WERKS = WRSZ.LOCNR
   AND MARC1.MATNR = WLK.ARTNR
  JOIN MAKT
    ON MAKT.MATNR = WLK.ARTNR
   AND MAKT.SPRAS = 'E'
  LEFT JOIN MARC AS DC01
    ON DC01.WERKS = 'GD01' AND DC01.MATNR = WLK.ARTNR
  LEFT JOIN MARC AS DC02
    ON DC02.WERKS = 'GD02' AND DC02.MATNR = WLK.ARTNR
  LEFT JOIN MARC AS DC03
    ON DC03.WERKS = 'GD03' AND DC03.MATNR = WLK.ARTNR
  LEFT JOIN MARC AS DC07
    ON DC07.WERKS = 'GD07' AND DC07.MATNR = WLK.ARTNR
  WHERE
    WRSZ.LOCNR IN ('G030','G105','G113','G114','G115','G118','G129','G581')
    AND LEFT(MARA.MATKL,4) = '0001'
    AND MARA.ATTYP = '12'
    AND MARA.MTART = 'Z100'
    AND (
      (WRSZ.LOCNR = 'G030'   AND WLK.FILIA LIKE 'DER%')
      OR (WRSZ.LOCNR IN ('G105','G113','G114','G115','G118','G129','G581') AND WLK.FILIA LIKE 'STP%')
      OR WLK.FILIA LIKE 'AU_PRM%'
    )
),
FILTERED AS (
  SELECT
    ARTNR,
    DISPLAY,
    DESCRIPTION,
    STORE,
    STORE_STATUS,
    STORE_LISTING,
    SL_VALID_FROM,
    SL_VALID_TO,
    CASE WHEN STORE = 'G030' THEN 'GD07' ELSE 'GD03' END         AS HOME_DC,
    CASE WHEN STORE = 'G030' THEN GD07_STATUS ELSE GD03_STATUS END AS HOME_DC_STATUS,
    CASE WHEN STORE = 'G030' THEN 'GD02' ELSE 'GD01' END         AS BROKERAGE_DC,
    CASE WHEN STORE = 'G030' THEN GD02_STATUS ELSE GD01_STATUS END AS BROKERAGE_DC_STATUS
  FROM STORE_LISTINGS
  WHERE
    RN = 1
    AND (CASE WHEN STORE = 'G030' THEN GD02_STATUS ELSE GD01_STATUS END) IN ('10','20','21')
),
UNIQUE_ARTICLES AS (
  SELECT
    *,
    ROW_NUMBER() OVER (
      PARTITION BY DISPLAY
      ORDER BY SL_VALID_FROM DESC
    ) AS RN2
  FROM FILTERED
),
LATEST_WLK1 AS (
  SELECT
    ARTNR,
    FILIA,
    DATAB,
    DATBI,
    ROW_NUMBER() OVER (
      PARTITION BY ARTNR, FILIA
      ORDER BY DATBI DESC
    ) AS RN
  FROM WLK1
)
SELECT
  UA.DISPLAY,
  UA.DESCRIPTION,
  UA.STORE,
  UA.STORE_STATUS,
  UA.STORE_LISTING,
  UA.SL_VALID_FROM,
  UA.SL_VALID_TO,
  UA.HOME_DC,
  UA.HOME_DC_STATUS,
  LH.DATAB AS HOME_DC_LISTING_VALID_FROM,
  LH.DATBI AS HOME_DC_LISTING_VALID_TO,
  UA.BROKERAGE_DC,
  UA.BROKERAGE_DC_STATUS,
  LB.DATAB AS BROKERAGE_DC_LISTING_VALID_FROM,
  LB.DATBI AS BROKERAGE_DC_LISTING_VALID_TO
FROM UNIQUE_ARTICLES UA
LEFT JOIN LATEST_WLK1 LH
  ON LH.ARTNR = UA.ARTNR
 AND LH.FILIA = UA.HOME_DC
 AND LH.RN = 1
LEFT JOIN LATEST_WLK1 LB
  ON LB.ARTNR = UA.ARTNR
 AND LB.FILIA = UA.BROKERAGE_DC
 AND LB.RN = 1
WHERE RN2 = 1
ORDER BY DISPLAY DESC;

