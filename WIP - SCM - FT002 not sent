-- 1) Aggregate each material × DC’s store statuses
WITH STORE_STATUS_AGG AS (
  SELECT
    S.ARTNR                  AS MATNR,
    SN.LOCNR                 AS DC,
    COUNT(*)                 AS TOTAL_STORES,
    SUM(CASE WHEN ST.MMSTA = '30' THEN 1 ELSE 0 END) AS STORES_30
  FROM WLK1       S
  INNER JOIN WRSZ       SN ON S.FILIA = SN.ASORT
  INNER JOIN MARC       ST ON ST.WERKS = SN.LOCNR
                          AND ST.MATNR = S.ARTNR
  WHERE S.DATBI > CURRENT_DATE
  GROUP BY S.ARTNR, SN.LOCNR
)

SELECT DISTINCT
    mvke.ZZPRGRP || ' - ' || T.EKNAM    AS BUYING_DIRECTOR,
    CASE
      WHEN SSA.TOTAL_STORES = SSA.STORES_30
           AND ZACDC_FREE_TASK.POSTED_ON IS NULL
      THEN 'All stores at 30 and no MyBulletin'
      ELSE ''
    END                                  AS ERROR,
    RIGHT(MARA.MATNR, 6)                 AS Display_ID,
    MAKT_EN.MAKTX                        AS DESCRIPTION_EN,
    MARC.WERKS                           AS DC,
    MARC.MMSTA                           AS DC_STATUS,
    STORESTATUS.MMSTA                    AS STORE_STATUS,
    CASE WHEN DC.FILIA IS NOT NULL THEN 'x' ELSE '' END         AS DC_LISTING,
    CASE WHEN STORE.FILIA IS NOT NULL THEN 'x' ELSE '' END      AS STORE_LISTING,
    CASE WHEN X.EBELN IS NOT NULL THEN 'x' ELSE '' END          AS Active_Contract,
    ZACDC_FREE_TASK.POSTED_ON           AS Zero_SOH_Bulletin_Posted,
    RIGHT(MARA.MATKL,2) || ' - ' || WRF_MATGRP_MD4T.LTEXT    AS CG

FROM MARA

  LEFT JOIN WRF_MATGRP_MD4T
    ON WRF_MATGRP_MD4T.NODE = MARA.MATKL
   AND WRF_MATGRP_MD4T.SPRAS = 'E'

  INNER JOIN INOB
    ON INOB.OBJEK = MARA.MATNR
   AND INOB.OBTAB = 'MARAT'
   AND INOB.KLART = '026'

  INNER JOIN AUSP
    ON INOB.CUOBJ = AUSP.OBJEK
   AND AUSP.ATINN IN ('0000009663','0000007846')

  INNER JOIN MVKE
    ON MVKE.MATNR = MARA.MATNR
   AND MVKE.VKORG = '5998'
   AND MVKE.VTWEG = '10'
   AND (
       RIGHT(LEFT(MARA.PRDHA,5),1) IN ('1','3')
       OR (
         RIGHT(LEFT(MARA.PRDHA,5),1) = '4'
         AND RIGHT(LEFT(MVKE.PRODH,5),1) <> '2'
       )
   )

  INNER JOIN MARC
    ON MARC.MATNR = MARA.MATNR
   AND (
       MARC.WERKS IN (
         'GD01','GD02','GD03','GD04','GD05',
         'GD06','GD07','GD08','GD21','GD22'
       )
       OR (
         MARC.WERKS IN ('GD03','GD07')
         AND MVKE.ZZPRGRP NOT IN ('G08','G09')
       )
   )

  -- join in our store‐status aggregation
  LEFT JOIN STORE_STATUS_AGG SSA
    ON SSA.MATNR = MARA.MATNR
   AND SSA.DC    = MARC.WERKS

  LEFT JOIN WLK1 DC
    ON DC.ARTNR = MARA.MATNR
   AND DC.DATBI >= CURRENT_DATE
   AND DC.FILIA = MARC.WERKS

  LEFT JOIN WLK1 STORE
    ON STORE.ARTNR = MARA.MATNR
   AND STORE.DATBI > CURRENT_DATE
   AND MARC.WERKS = CASE
       WHEN STORE.FILIA LIKE '%MIN-%' THEN 'GD01'
       WHEN STORE.FILIA LIKE '%DER-%' THEN 'GD02'
       WHEN STORE.FILIA LIKE '%STP-%' THEN 'GD03'
       WHEN STORE.FILIA LIKE '%PRE-%' THEN 'GD04'
       WHEN STORE.FILIA LIKE '%DAN-%' THEN 'GD05'
       WHEN STORE.FILIA LIKE '%BRE-%' THEN 'GD06'
       WHEN STORE.FILIA LIKE '%RGY-%' THEN 'GD07'
       WHEN STORE.FILIA LIKE '%JKT-%' THEN 'GD08'
     END
   AND STORE.FILIA NOT LIKE '%DUMY%'

  LEFT JOIN WRSZ STORENO
    ON STORE.FILIA = STORENO.ASORT

  LEFT JOIN MARC STORESTATUS
    ON STORENO.LOCNR = STORESTATUS.WERKS
   AND STORESTATUS.MATNR = MARA.MATNR

  LEFT JOIN (
    SELECT DISTINCT
      EKPO.MATNR, EKPO.WERKS, EKPO.EBELN,
      EKKO.KDATB, EKKO.KDATE, EKPO.LOEKZ
    FROM EKPO
    INNER JOIN EKKO
      ON EKKO.EBELN = EKPO.EBELN
     AND EKKO.BSTYP = 'K'
     AND EKKO.KDATB <= CURRENT_DATE
     AND EKKO.KDATE >= CURRENT_DATE
  ) X
    ON X.MATNR = MARA.MATNR
   AND X.WERKS = MARC.WERKS
   AND X.LOEKZ <> 'L'

  LEFT JOIN MAKT MAKT_EN
    ON MAKT_EN.MATNR = MARA.MATNR
   AND MAKT_EN.SPRAS = 'E'

  LEFT JOIN T024 T
    ON T.EKGRP = MVKE.ZZPRGRP

  LEFT JOIN WAKP
    ON WAKP.ARTNR = MARA.MATNR

  LEFT JOIN ZACDC_FREE_TASKM
    ON ZACDC_FREE_TASKM.MATNR = MARA.MATNR

  LEFT JOIN ZACDC_FREE_TASKW
    ON ZACDC_FREE_TASKW.TASKID = ZACDC_FREE_TASKM.TASKID
   AND ZACDC_FREE_TASKW.WERKS = MARC.WERKS

  LEFT JOIN ZACDC_FREE_TASK
    ON ZACDC_FREE_TASK.TASKID = ZACDC_FREE_TASKW.TASKID
   AND ZACDC_FREE_TASK.TRIGER = 'FT002'

WHERE
  AUSP.OBJEK IS NOT NULL
  AND WAKP.ARTNR IS NULL
  AND MARA.ATTYP = 12
  AND MARA.MTART = 'Z100'
  AND SSA.TOTAL_STORES = SSA.STORES_30       -- ensures *all* stores are 30
  AND ZACDC_FREE_TASK.POSTED_ON IS NULL     -- no bulletin posted yet

ORDER BY
  Display_ID ASC,
  MARC.WERKS ASC;
