WITH
  dc_store AS (
    SELECT
      R.LOCLB AS DC,
      R.LOCNR AS STORE
    FROM WRF3 R
    WHERE R.LOCLB LIKE 'GD%'
      AND (R.MATKL IS NULL OR R.MATKL = '')
      AND R.DATAB  <= CURRENT_DATE
      AND R.DATBI  >= CURRENT_DATE
  ),
  base_data AS (
    SELECT
      m.MATNR                             AS ArtNr,
      RIGHT(m.MATNR,6)                    AS DisplayID,
      mk.MAKTX                            AS DESCRIPTION_EN,
      CASE
        WHEN SUBSTRING(v.PRODH,5,1) = '1' THEN 'Core Range'
        WHEN SUBSTRING(v.PRODH,5,1) = '3' THEN 'Seasonal'
        ELSE ''
      END                                 AS PRODUCT_HIERARCHY,
      RIGHT(m.MATKL,2) || ' - ' || grp.LTEXT AS ASCG,
      dc.WERKS                            AS DC,
      dcw.DATAB                           AS DC_VALID_FROM,
      dcw.DATBI                           AS DC_VALID_TILL,
      ds.STORE                            AS STORE,
      mstr.MMSTA                          AS STORE_STATUS,
      mstr.MMSTD                          AS STORE_VALID_FROM,
      CASE WHEN dcw.ARTNR IS NOT NULL THEN 1 ELSE 0 END        AS ActiveDCListingFlag,
      CASE WHEN wlkst.ARTNR IS NOT NULL THEN 1 ELSE 0 END      AS ActiveStoreListingFlag
    FROM MARA m
    INNER JOIN MVKE v
      ON v.MATNR = m.MATNR
     AND v.VKORG = '5998'
     AND v.VTWEG = '10'
     AND SUBSTRING(v.PRODH,5,1) IN ('1','3')
    INNER JOIN MARC dc
      ON dc.MATNR = m.MATNR
     AND dc.WERKS LIKE 'GD%'
     AND dc.MMSTA IN ('20','21','30')
     AND dc.MMSTD <= CURRENT_DATE
    LEFT JOIN WLK1 dcw
      ON dcw.ARTNR = m.MATNR
     AND dcw.FILIA = dc.WERKS
     AND dcw.DATAB <= CURRENT_DATE
     AND dcw.DATBI >= CURRENT_DATE
    JOIN dc_store ds
      ON ds.DC = dc.WERKS
    INNER JOIN MARC mstr
      ON mstr.MATNR = m.MATNR
     AND mstr.WERKS = ds.STORE
     AND mstr.MMSTD <= CURRENT_DATE
    LEFT JOIN WLK1 wlkst
      ON wlkst.ARTNR = m.MATNR
     AND wlkst.FILIA = ds.STORE
     AND wlkst.DATAB <= CURRENT_DATE
     AND wlkst.DATBI >= CURRENT_DATE
    LEFT JOIN MAKT mk
      ON mk.MATNR = m.MATNR
     AND mk.SPRAS = 'E'
    LEFT JOIN WRF_MATGRP_MD4T grp
      ON grp.NODE  = m.MATKL
     AND grp.SPRAS = 'E'
    WHERE m.MTART = 'Z100'
      AND m.ATTYP = 12
  ),
  flagged AS (
    SELECT
      bd.*,
      ROW_NUMBER() OVER (
        PARTITION BY DisplayID, DC
        ORDER BY 
          CASE WHEN STORE_STATUS <> '30' THEN 0 ELSE 1 END,
          STORE_VALID_FROM DESC
      ) AS rn,
      MAX(CASE WHEN STORE_STATUS = '30' THEN 1 ELSE 0 END)
        OVER (PARTITION BY ArtNr, DC)   AS AnyStore30,
      MAX(CASE WHEN STORE_STATUS <> '30' THEN 1 ELSE 0 END)
        OVER (PARTITION BY ArtNr, DC)   AS AnyStoreNot30
    FROM base_data bd
  )
SELECT
  DisplayID,
  DESCRIPTION_EN,
  PRODUCT_HIERARCHY,
  ASCG,
  DC,
  DC_VALID_FROM,
  DC_VALID_TILL,
  STORE,
  STORE_STATUS,
  STORE_VALID_FROM
FROM flagged
WHERE AnyStore30        = 1
  AND AnyStoreNot30     = 1
  AND rn                = 1
  AND (ActiveDCListingFlag = 1 OR ActiveStoreListingFlag = 1)
ORDER BY DisplayID;
