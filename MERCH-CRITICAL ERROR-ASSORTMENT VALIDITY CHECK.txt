SELECT DISTINCT
LEFT (WRSZ.ASORT,3) REGION,
WRSZ.ASORT,
SUBSTRING (WRST.NAME1,1,15) DESC,
CASE WHEN WLK1.FILIA IS NULL THEN 'x' ELSE '' END AS ASSORTMENT_WITHOUT_LISTING,
CASE WHEN Y.LAYGR is NULL THEN 'x' else '' END AS NOT_VALID_AFTER_6_MONTHS,
s.lm_date_fr AS Weekly_Version_Start_Not_Wednesday,
case when ZP2M_MASTER_ID.MAKTX is null then 'x' else '' end Cluster_Description_Missing


FROM WRSZ

INNER JOIN WRST ON
WRST.ASORT = WRSZ.ASORT AND
WRST.SPRAS = 'E' AND
WRST.NAME1 NOT LIKE '%dummy%'

INNER JOIN WRF1 ON
WRF1.LOCNR = WRSZ.LOCNR AND
WRF1.EROED <= CURRENT_DATE AND
WRF1.EROED >= 20000101 and
(wrf1.SCHLD > current_date or left(wrf1.schld,1) = 0)

LEFT JOIN WLK1 ON
WLK1.FILIA = WRSZ.ASORT AND WLK1.DATAB <= CURRENT_DATE AND WLK1.DATBI >= CURRENT_DATE

LEFT JOIN (
SELECT * FROM WLMV X
WHERE LAYMOD_VER = (SELECT MAX (LAYMOD_VER) FROM WLMV WHERE LAYGR = X.LAYGR)
) Y ON Y.LAYGR = WRSZ.ASORT AND Y.LM_DATE_FR >= ADD_MONTHS(CURRENT_DATE,6)

LEFT JOIN WLMV S ON
    S.LAYGR = WRSZ.ASORT
    AND S.LM_DATE_FR < ADD_DAYS(current_date,7)
    and s.lm_date_fr >= current_date
    and DAYNAME(s.lm_date_fr) <> DAYNAME('2024-03-06')

left join ZP2M_MASTER_ID on
    left(ZP2M_MASTER_ID.asort,7) = left(wrsz.asort,7)
    and ZP2M_MASTER_ID.VKORG = '5998'
    and right(ZP2M_MASTER_ID.asort,1) = '*'

WHERE
WRSZ.DATBI >= CURRENT_DATE AND
WRSZ.DATAB <= CURRENT_DATE AND
WRSZ.ASORT NOT LIKE '%-997%' AND
WRSZ.ASORT NOT LIKE '%-SUB%' AND
WRSZ.ASORT NOT LIKE '%DP4%' AND
WRSZ.ASORT NOT LIKE '%PRM%' AND
WRSZ.ASORT NOT LIKE '%-V%' AND
WRSZ.ASORT NOT LIKE 'ALL%' and
WRSZ.ASORT NOT LIKE '%-44%' and
WRSZ.ASORT NOT LIKE '%303%' and
WRSZ.ASORT NOT LIKE '%304%' and
WRSZ.ASORT NOT LIKE '%305%' and
WRSZ.ASORT NOT LIKE '%352%' and
/*303&304 are Produce - Berry Chiller; -44 is Visual Only Endcap, 352 is Grab&Go*/
WRSZ.LOCNR LIKE 'G%' AND
WRSZ.ASORT NOT LIKE 'G%' AND
(WLK1.FILIA is NULL or Y.LAYGR is NULL OR
S.LM_DATE_FR is not null or (case when ZP2M_MASTER_ID.MAKTX is null then 'x' else '' end <> '' and wrsz.asort not like '%-P%'))

ORDER BY REGION, ASORT