SELECT DISTINCT			
	mvke.ZZPRGRP||' - '||T.EKNAM AS BUYING_DIRECTOR,		
      CASE 

            WHEN (MARC.MMSTA IN ('30', '99') AND MARC.MMSTD <= CURRENT_DATE AND (DC.FILIA IS NOT NULL OR STORE.FILIA IS NOT NULL)) THEN CONCAT('DC OR STORE LISTED WITH STATUS ', MARC.MMSTA)			
		WHEN (STORE.FILIA IS NOT NULL AND DC.FILIA IS NULL) THEN 'STORE LISTED WITHOUT DC LISTING'	
            WHEN ((MARA.TEMPB = '9A' OR mara.TEMPB = '8A') AND DC.FILIA IS NOT NULL AND MARC.WERKS IN ('GD01','GD02','GD04', 'GD05')) THEN 'BROKERAGE SITE ARTICLE INCORRECTLY LISTED TO DC'
		WHEN (DC.FILIA IS NOT NULL AND STORE.FILIA IS NULL)  THEN 'DC LISTED WITHOUT STORE LISTING'
            WHEN (X.KDATB <=CURRENT_DATE AND X.KDATE >= CURRENT_DATE AND DC.FILIA IS NULL AND STORE.FILIA IS NULL) THEN 'INVALID DC AND STORE LISTING WITH ACTIVE CONTRACT'		
												
		ELSE '' END AS ERROR,	
      RIGHT (MARA.MATNR, 6) AS Display_ID,			
      	MAKT_EN.MAKTX AS DESCRIPTION_EN,
CASE WHEN RIGHT(LEFT(MVKE.PRODH, 5),1) = '1' THEN 'Core Range'			
     WHEN RIGHT(LEFT(MVKE.PRODH, 5),1) = '3' THEN 'Seasonal'			
     ELSE ''			
END AS PRODUCT_HIERARCHY,					
	MARC.WERKS AS DC, MARC.MMSTA AS DC_STATUS,		
	CASE WHEN DC.FILIA IS NOT NULL THEN 'x' ELSE '' END AS DC_LISTING,		
	CASE WHEN STORE.FILIA IS NOT NULL THEN 'x' ELSE '' END AS STORE_LISTING,
X.EBELN AS CONTRACT_NUMBER,			
X.KDATB AS VALID_FROM,			
X.KDATE AS VALID_TO,					
      right(mara.MATKL,2)|| ' - '|| WRF_MATGRP_MD4T.LTEXT ASCG			
			
			
FROM			
	MARA		
			
LEFT JOIN			
      WRF_MATGRP_MD4T ON			
            WRF_MATGRP_MD4T.NODE = MARA.MATKL AND			
            WRF_MATGRP_MD4T.SPRAS = 'E'			
			
Inner JOIN			
	MVKE ON		
		MVKE.MATNR = MARA.MATNR AND	
		MVKE.VKORG = '5998' AND	
		MVKE.VTWEG = '10'	
			
			
INNER JOIN			
	MARC ON		
		MARC.MATNR = MARA.MATNR AND	
		(MARC.WERKS IN ('GD01', 'GD02', 'GD04', 'GD05', 'GD06', 'GD08', 'GD21', 'GD22', 'GD24') OR	
		(MARC.WERKS IN ('GD03', 'GD07') AND MVKE.ZZPRGRP NOT IN ('G08', 'G09')))	
			
LEFT JOIN			
	WLK1 DC ON		
		DC.ARTNR = MARA.MATNR AND	
		DC.DATBI >= add_days(current_date,2) AND	
		DC.FILIA = MARC.WERKS                              /**--Update Region Here**/	
			
			
LEFT JOIN			
	WLK1 STORE ON		
		STORE.ARTNR = MARA.MATNR AND	
		STORE.DATBI > add_days(current_date,2) AND	
		MARC.WERKS = CASE WHEN STORE.FILIA like '%MIN-%' and (mara.TEMPB = '9A' OR mara.TEMPB = '8A') then 'GD21'
                        WHEN STORE.FILIA like '%MIN-%' and (mara.TEMPB <> '9A' OR mara.TEMPB <> '8A') then 'GD01'  
                        WHEN STORE.FILIA like '%DER-%' and (mara.TEMPB = '9A' OR mara.TEMPB = '8A') then 'GD22' 
                        WHEN STORE.FILIA like '%DER-%' and (mara.TEMPB <> '9A' OR mara.TEMPB <> '8A') then 'GD02' 
                        WHEN STORE.FILIA like '%STP-%' THEN 'GD03'			
                        WHEN STORE.FILIA like '%PRE-%' and (mara.TEMPB = '9A' OR mara.TEMPB = '8A') then 'GD21' 
                        WHEN STORE.FILIA like '%PRE-%' and (mara.TEMPB <> '9A' OR mara.TEMPB <> '8A') then 'GD04'
                        WHEN STORE.FILIA like '%DAN-%' and (mara.TEMPB = '9A' OR mara.TEMPB = '8A') then 'GD22' 	
                        WHEN STORE.FILIA like '%DAN-%' and (mara.TEMPB <> '9A' OR mara.TEMPB <> '8A') then 'GD05'		
                        WHEN STORE.FILIA like '%BRE-%' THEN 'GD06'			
                        WHEN STORE.FILIA like '%RGY-%' THEN 'GD07'			
                        WHEN STORE.FILIA like '%JKT-%' THEN 'GD08' END AND STORE.FILIA NOT LIKE '%DUMY%' and store.filia not like '%000%'			
			
                   			
			
LEFT JOIN			
	(SELECT DISTINCT		
		EKPO.MATNR, EKPO.WERKS, EKPO.EBELN, EKKO.KDATB,EKKO.KDATE,EKPO.LOEKZ	
               FROM EKPO			
               INNER JOIN EKKO ON EKKO.EBELN = EKPO.EBELN AND EKKO.BSTYP = 'K' AND (EKKO.KDATB <= CURRENT_DATE AND EKKO.KDATE >= CURRENT_DATE)) X			
	ON X.MATNR = MARA.MATNR AND X.WERKS = MARC.WERKS AND X.LOEKZ !='L'		
			
			
LEFT JOIN			
	MAKT MAKT_EN ON		
		MAKT_EN.MATNR = MARA.MATNR AND	
		MAKT_EN.SPRAS = 'E'	
			
LEFT JOIN			
	T024 T ON		
		T.EKGRP = MVKE.ZZPRGRP	
			
LEFT JOIN			
        WAKP on			
    wakp.artnr = mara.matnr			
			
			
WHERE			
		
 (RIGHT(LEFT(MARA.PRDHA, 5),1) in ('1','3') OR(			
              RIGHT(LEFT(MARA.PRDHA, 5),1) = '4' AND RIGHT(LEFT(MVKE.PRODH, 5),1) <> '2')) and			
			
    wakp.artnr is null AND			
	MARA.ATTYP = 12 AND		
	MARA.MTART = 'Z100' AND		
	
      CASE WHEN (MARC.MMSTA IN ('30', '99') AND MARC.MMSTD <= CURRENT_DATE AND (DC.FILIA IS NOT NULL OR STORE.FILIA IS NOT NULL)) THEN CONCAT('DC OR STORE LISTED WITH STATUS ', MARC.MMSTA)			
		WHEN (STORE.FILIA IS NOT NULL AND DC.FILIA IS NULL) THEN 'STORE LISTED WITHOUT DC LISTING'	
           WHEN ((MARA.TEMPB = '9A' OR mara.TEMPB = '8A') AND DC.FILIA IS NOT NULL AND MARC.WERKS IN ('GD01','GD02','GD04', 'GD05')) AND DC.FILIA <> 'GD05' THEN 'BROKERAGE SITE ARTICLE INCORRECTLY LISTED TO DC'
		WHEN (DC.FILIA IS NOT NULL AND STORE.FILIA IS NULL)  THEN 'DC LISTED WITHOUT STORE LISTING'
            WHEN (X.KDATB <=CURRENT_DATE AND X.KDATE >= CURRENT_DATE AND DC.FILIA IS NULL AND STORE.FILIA IS NULL) THEN 'INVALID DC AND STORE LISTING WITH ACTIVE CONTRACT'		
			
		ELSE '' END <> ''	
			
			
			
ORDER BY			
	Display_ID ASC, MARC.WERKS ASC
