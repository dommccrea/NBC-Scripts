SELECT DISTINCT
    mvke.ZZPRGRP || ' - ' || T.EKNAM      AS BUYING_DIRECTOR,
    CASE
        WHEN MARC.MMSTA IN ('30','99')
             AND MARC.MMSTD <= CURRENT_DATE
             AND (DC.FILIA IS NOT NULL OR STORE.FILIA IS NOT NULL)
          THEN CONCAT('DC OR STORE LISTED WITH STATUS ', MARC.MMSTA)
        WHEN STORE.FILIA IS NOT NULL
             AND DC.FILIA IS NULL
          THEN 'STORE LISTED WITHOUT DC LISTING'
        WHEN MARA.TEMPB IN ('9A','8A')
             AND DC.FILIA IS NOT NULL
             AND MARC.WERKS IN ('GD01','GD02','GD04','GD05')
          THEN 'BROKERAGE SITE ARTICLE INCORRECTLY LISTED TO DC'
        WHEN DC.FILIA IS NOT NULL
             AND STORE.FILIA IS NULL
          THEN 'DC LISTED WITHOUT STORE LISTING'
        WHEN X.KDATB <= CURRENT_DATE
             AND X.KDATE  >= CURRENT_DATE
             AND DC.FILIA IS NULL
             AND STORE.FILIA IS NULL
          THEN 'INVALID DC AND STORE LISTING WITH ACTIVE CONTRACT'
        ELSE ''
    END                                    AS ERROR,
    RIGHT(MARA.MATNR,6)                    AS Display_ID,
    MAKT_EN.MAKTX                          AS DESCRIPTION_EN,
    CASE
        WHEN RIGHT(LEFT(MVKE.PRODH,5),1) = '1' THEN 'Core Range'
        WHEN RIGHT(LEFT(MVKE.PRODH,5),1) = '3' THEN 'Seasonal'
        ELSE ''
    END                                    AS PRODUCT_HIERARCHY,
    MARC.WERKS                             AS DC,
    MARC.MMSTA                             AS DC_STATUS,
    CASE WHEN DC.FILIA IS NOT NULL THEN 'x' ELSE '' END
                                          AS DC_LISTING,
    CASE WHEN STORE.FILIA IS NOT NULL THEN 'x' ELSE '' END
                                          AS STORE_LISTING,
    X.EBELN                                AS CONTRACT_NUMBER,
    X.KDATB                                AS VALID_FROM,
    X.KDATE                                AS VALID_TO,
    RIGHT(MARA.MATKL,2) || ' - ' || WRF_MATGRP_MD4T.LTEXT
                                          AS ASCG

FROM MARA

LEFT JOIN WRF_MATGRP_MD4T
  ON WRF_MATGRP_MD4T.NODE  = MARA.MATKL
 AND WRF_MATGRP_MD4T.SPRAS = 'E'

INNER JOIN MVKE
  ON MVKE.MATNR   = MARA.MATNR
 AND MVKE.VKORG   = '5998'
 AND MVKE.VTWEG   = '10'

INNER JOIN MARC
  ON MARC.MATNR = MARA.MATNR
 AND (
       MARC.WERKS IN ('GD01','GD02','GD04','GD05','GD06','GD08','GD21','GD22','GD24')
    OR (MARC.WERKS IN ('GD03','GD07') AND MVKE.ZZPRGRP NOT IN ('G08','G09'))
     )

LEFT JOIN WLK1 DC
  ON DC.ARTNR    = MARA.MATNR
 AND DC.DATBI    >= ADD_DAYS(CURRENT_DATE,2)
 AND DC.FILIA     = MARC.WERKS

LEFT JOIN WLK1 STORE
  ON STORE.ARTNR = MARA.MATNR
 AND STORE.DATBI > ADD_DAYS(CURRENT_DATE,2)
 AND MARC.WERKS  = CASE
        -- special override when category = '01'
        WHEN STORE.FILIA LIKE '%STP-%'
         AND RIGHT(LEFT(MARA.MATKL,6),2) = '01'      THEN 'GD01'
        WHEN STORE.FILIA LIKE '%RGY-%'
         AND RIGHT(LEFT(MARA.MATKL,6),2) = '01'      THEN 'GD02'

        -- existing mappings
        WHEN STORE.FILIA LIKE '%MIN-%'
         AND MARA.TEMPB  IN ('9A','8A')             THEN 'GD21'
        WHEN STORE.FILIA LIKE '%MIN-%'
         AND MARA.TEMPB NOT IN ('9A','8A')          THEN 'GD01'
        WHEN STORE.FILIA LIKE '%DER-%'
         AND MARA.TEMPB  IN ('9A','8A')             THEN 'GD22'
        WHEN STORE.FILIA LIKE '%DER-%'
         AND MARA.TEMPB NOT IN ('9A','8A')          THEN 'GD02'
        WHEN STORE.FILIA LIKE '%STP-%'              THEN 'GD03'
        WHEN STORE.FILIA LIKE '%PRE-%'
         AND MARA.TEMPB  IN ('9A','8A')             THEN 'GD21'
        WHEN STORE.FILIA LIKE '%PRE-%'
         AND MARA.TEMPB NOT IN ('9A','8A')          THEN 'GD04'
        WHEN STORE.FILIA LIKE '%DAN-%'
         AND MARA.TEMPB  IN ('9A','8A')             THEN 'GD22'
        WHEN STORE.FILIA LIKE '%DAN-%'
         AND MARA.TEMPB NOT IN ('9A','8A')          THEN 'GD05'
        WHEN STORE.FILIA LIKE '%BRE-%'              THEN 'GD06'
        WHEN STORE.FILIA LIKE '%RGY-%'              THEN 'GD07'
        WHEN STORE.FILIA LIKE '%JKT-%'              THEN 'GD08'
        ELSE NULL
    END
 AND STORE.FILIA NOT LIKE '%DUMY%'
 AND STORE.FILIA NOT LIKE '%000%'

LEFT JOIN (
    SELECT DISTINCT
        EKPO.MATNR,
        EKPO.WERKS,
        EKPO.EBELN,
        EKKO.KDATB,
        EKKO.KDATE,
        EKPO.LOEKZ
    FROM EKPO
    INNER JOIN EKKO
      ON EKKO.EBELN = EKPO.EBELN
     AND EKKO.BSTYP = 'K'
     AND EKKO.KDATB <= CURRENT_DATE
     AND EKKO.KDATE  >= CURRENT_DATE
) X
  ON X.MATNR    = MARA.MATNR
 AND X.WERKS    = MARC.WERKS
 AND X.LOEKZ   <> 'L'

LEFT JOIN MAKT MAKT_EN
  ON MAKT_EN.MATNR = MARA.MATNR
 AND MAKT_EN.SPRAS = 'E'

LEFT JOIN T024 T
  ON T.EKGRP = MVKE.ZZPRGRP

LEFT JOIN WAKP
  ON WAKP.ARTNR = MARA.MATNR

WHERE
      (RIGHT(LEFT(MARA.PRDHA,5),1) IN ('1','3')
    OR (RIGHT(LEFT(MARA.PRDHA,5),1) = '4'
        AND RIGHT(LEFT(MVKE.PRODH,5),1) <> '2'))
  AND WAKP.ARTNR IS NULL
  AND MARA.ATTYP    = 12
  AND MARA.MTART    = 'Z100'
  AND CASE
        WHEN MARC.MMSTA IN ('30','99')
         AND MARC.MMSTD <= CURRENT_DATE
         AND (DC.FILIA IS NOT NULL OR STORE.FILIA IS NOT NULL)
          THEN CONCAT('DC OR STORE LISTED WITH STATUS ', MARC.MMSTA)
        WHEN STORE.FILIA IS NOT NULL
         AND DC.FILIA IS NULL
          THEN 'STORE LISTED WITHOUT DC LISTING'
        WHEN MARA.TEMPB IN ('9A','8A')
         AND DC.FILIA IS NOT NULL
         AND MARC.WERKS IN ('GD01','GD02','GD04','GD05')
          THEN 'BROKERAGE SITE ARTICLE INCORRECTLY LISTED TO DC'
        WHEN DC.FILIA IS NOT NULL
         AND STORE.FILIA IS NULL
          THEN 'DC LISTED WITHOUT STORE LISTING'
        WHEN X.KDATB <= CURRENT_DATE
         AND X.KDATE  >= CURRENT_DATE
         AND DC.FILIA IS NULL
         AND STORE.FILIA IS NULL
          THEN 'INVALID DC AND STORE LISTING WITH ACTIVE CONTRACT'
        ELSE ''
    END <> ''

ORDER BY
    Display_ID ASC,
    MARC.WERKS  ASC;
