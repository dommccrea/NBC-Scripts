WITH  LATEST_CO_ARTICLE (
	LIFNR,
	MATNR,
      EBELN,
      VERKF,
	RANKID
) AS
(
SELECT DISTINCT
		PO.LIFNR,
		POL.MATNR,
            PO.EBELN,
            PO.VERKF,
		/** RANK BY GR_DATE/GR_TIME/PO_NUMBER GROUPED BY ARTICLE/DC **/
		RANK() OVER (PARTITION BY POL.MATNR, PO.LIFNR ORDER BY PO.KDATE DESC, PO.EBELN DESC) AS RANKID
	FROM
		EKKO PO
	INNER JOIN
		EKPO POL ON
			PO.EBELN = POL.EBELN AND
			/** DESTINATION IS AN AUS DC **/
			POL.WERKS IN ('GD01', 'GD02', 'GD03', 'GD04', 'GD05', 'GD06', 'GD07', 'GD08', 'GD21', 'GD22', 'GD24') AND
			/** LINE ITEM IS NOT MARKED FOR DELETION **/
			POL.LOEKZ != 'L' AND
			/** PURCHASING DOCUMENT IS A CONTRACT **/
			POL.BSTYP = 'K'  AND
			/** PO LINE ITEM ARTICLE IS NOT BLANK **/
			POL.MATNR != ''
       INNER JOIN BUT000
            ON BUT000.PARTNER = PO.LIFNR AND
            BUT000.BU_SORT1 NOT LIKE 'GD%'
WHERE PO.KDATE >= ADD_YEARS (CURRENT_DATE, -1)
),

MAIN AS 
(
SELECT DISTINCT
        CASE
            WHEN RIGHT(LEFT(MVKE.PRODH, 10),6) = '100001' THEN 'CORE RANGE GS IB PRODUCT'
            WHEN RIGHT(LEFT(MVKE.PRODH, 10),6) = '100002' THEN 'CORE RANGE GROUP PRODUCT'
            WHEN RIGHT(LEFT(MVKE.PRODH, 10),6) = '100003' THEN 'CORE RANGE NATIONAL PRODUCT'
            WHEN RIGHT(LEFT(MVKE.PRODH, 10),6) = '100004' THEN 'CORE RANGE REGIONAL PRODUCT'
            WHEN RIGHT(LEFT(MVKE.PRODH, 10),6) = '100005' THEN 'CORE RANGE CO-BUY PRODUCT'
            WHEN RIGHT(LEFT(MVKE.PRODH, 10),6) = '300001' THEN 'SEASONAL GS IB PRODUCT'
            WHEN RIGHT(LEFT(MVKE.PRODH, 10),6) = '300002' THEN 'SEASONAL GROUP PRODUCT'
            WHEN RIGHT(LEFT(MVKE.PRODH, 10),6) = '300003' THEN 'SEASONAL NATIONAL PRODUCT'
            WHEN RIGHT(LEFT(MVKE.PRODH, 10),6) = '300004' THEN 'SEASONAL REGIONAL PRODUCT'
            WHEN RIGHT(LEFT(MVKE.PRODH, 10),6) = '300005' THEN 'SEASONAL CO-BUY PRODUCT'
            WHEN RIGHT(LEFT(MVKE.PRODH, 10),6) = '200001' THEN 'SPECIAL BUY GS IB PRODUCT'
            WHEN RIGHT(LEFT(MVKE.PRODH, 10),6) = '200002' THEN 'SPECIAL BUY GROUP PRODUCT'
            WHEN RIGHT(LEFT(MVKE.PRODH, 10),6) = '200003' THEN 'SPECIAL BUY NATIONAL PRODUCT'
            WHEN RIGHT(LEFT(MVKE.PRODH, 10),6) = '200004' THEN 'SPECIAL BUY REGIONAL PRODUCT'
            WHEN RIGHT(LEFT(MVKE.PRODH, 10),6) = '200005' THEN 'SPECIAL BUY CO-BUY PRODUCT'
            WHEN RIGHT(LEFT(MVKE.PRODH, 10),6) = '400001' THEN 'COUNTRY SPECIFIC CLASSIFICATION GS IB'
            WHEN RIGHT(LEFT(MVKE.PRODH, 10),6) = '400002' THEN 'COUNTRY SPECIFIC CLASSIFICATION GROUP'
            WHEN RIGHT(LEFT(MVKE.PRODH, 10),6) = '400005' THEN 'COUNTRY SPECIFIC CLASSIFICATION / CO-BUY'
            ELSE '' END AS PRODUCT_CLASS,
	CASE
			WHEN COMP.ATTYP = '00' THEN 'SINGLE'
			WHEN COMP.ATTYP = '01' THEN 'GENERIC'
			WHEN COMP.ATTYP = '02' THEN 'GENERIC'
			WHEN COMP.ATTYP = '12' THEN 'DISPLAY'
		END AS ARTICLE_TYPE,
TO_VARCHAR(TO_DATE(XC.VKDAB, 'YYYYMMDD'), 'DD/MM/YYYY')  AS ON_SALE_DATE,
TWATT.AKTTT AS THEME_DESCRIPTION,
RIGHT(MARA.MATNR, 6) DISPLAY_ID,
BRANDT.BRAND_DESCR AS BRAND_NAME,
CASE WHEN BRAND.BRAND_TYPE = 1 THEN 'PRIVATE LABEL' WHEN BRAND.BRAND_TYPE = 2 THEN 'MANUFACTURER BRAND' ELSE '' END AS Brand_Type
,MAKT.MAKTX DESCRIPTION
,AUSP.ATWRT AS CBIS_CODE
,CASE 
			WHEN COMP.ATTYP = '00' AND COMP.MTART != 'Z200' THEN RIGHT(COMP.MATNR, 6)
			WHEN COMP.ATTYP = '00' AND COMP.MTART = 'Z200' THEN RIGHT(COMP.MATNR, 8)
			WHEN COMP.ATTYP = '01' THEN RIGHT(COMP.MATNR, 6)
			WHEN COMP.ATTYP = '02' THEN LEFT(RIGHT(COMP.MATNR, 9),6)
			WHEN COMP.ATTYP = '12' THEN RIGHT(COMP.MATNR, 6)
		END AS SELLABLE_ID
,LTRIM (COMP.MATNR, 0) AS SAP_ID
,CASE WHEN COMP.ATTYP = '02' THEN RIGHT(COMP.MATNR, 9) ELSE '' END AS VARIANTID
,LTRIM (LCO.LIFNR, 0) AS  VENDOR_ID
,T024.EKNAM BUYING_DICRECTOR
,CASE WHEN SUBSTR_BEFORE (MAKTC.MAKTX, ',') = '' THEN MAKTC.MAKTX ELSE SUBSTR_BEFORE (MAKTC.MAKTX, ',') END AS  SELLABLE_DESCRIPTION
,SUBSTR_AFTER (MAKTC.MAKTX, ',') AS  VARIANT_NAME
,CONCAT (CONCAT (COMP.NTGEW,'  '), COMP.GEWEI) AS WEIGHT
,LCO.EBELN AS SAP_Outline_Agreement
,LCO.VERKF AS Contract_No
--,A155.KBETR AS RETAIL
,CASE WHEN MARA.MTART = 'Z101' THEN A155.KBETR ELSE A073.KBETR END AS RETAIL
,CASE WHEN MARA.MTART = 'Z101' THEN A155.SOURCE ELSE A073.VKORG END RETAIL_SOURCE
,CONCAT(CONCAT(LTRIM(RIGHT(LEFT(MARA.MATKL,4),2),0),' - '),CAT.LTEXT) AS Category
,CONCAT(CONCAT(LTRIM(RIGHT(LEFT(MARA.MATKL,6),2),0),' - '),CG.LTEXT) AS CG
,CONCAT(CONCAT(LTRIM(RIGHT(LEFT(MARA.MATKL,8),2),0),' - '),SCG.LTEXT) AS SCG
,CASE WHEN AC.MATNR IS NOT NULL THEN 'X' ELSE '' END AS ACTIVE_CONTRACT
,BUT000.NAME_ORG1 AS SUPPLIER_NAME
,MEAN.EAN11 AS UPC
,Z.CALCULATEDBASEPRICE AS Unitprice

FROM MARA

	INNER JOIN MVKE
	ON MVKE.MATNR = MARA.MATNR
	AND MVKE.VKORG = 5998
	AND MVKE.VTWEG = 10

        LEFT JOIN
                INOB ON
                        INOB.OBJEK = MARA.MATNR AND
                        INOB.OBTAB = 'MARAT' AND
                        INOB.KLART = '026'
        LEFT JOIN
                AUSP ON
                        INOB.CUOBJ = AUSP.OBJEK AND
                        AUSP.ATINN IN ('0000009663', '0000007846')

	LEFT JOIN 
		MAST ON 
			MAST.MATNR = MARA.MATNR
	LEFT JOIN 
		STPO ON 
			STPO.STLNR = MAST.STLNR
	LEFT JOIN
		MARA COMP ON
			COMP.MATNR = STPO.IDNRK

    LEFT JOIN MAKT
            ON MAKT.MATNR = MARA.MATNR
                AND MAKT.SPRAS = 'E'

    LEFT JOIN MAKT MAKTC
            ON MAKTC.MATNR = COMP.MATNR
                AND MAKTC.SPRAS = 'E'

    LEFT JOIN T024
            ON T024.EKGRP = MVKE.ZZPRGRP

    LEFT JOIN LATEST_CO_ARTICLE LCO
            ON LCO.MATNR = MARA.MATNR AND LCO.RANKID = 1

     INNER JOIN
                    MARC ON MARC.MATNR = MARA.MATNR AND
                    MARC.WERKS IN ('GD01','GD02','GD03','GD04','GD05','GD06','GD07','GD08', 'GD21', 'GD22', 'GD24')

    LEFT JOIN
                    WLK1 DC ON DC.ARTNR = MARA.MATNR AND
                    DC.DATBI >= CURRENT_DATE AND
                    DC.FILIA = MARC.WERKS    

    LEFT JOIN WLK1 STORE
            ON STORE.ARTNR = MARA.MATNR
                AND STORE.DATBI >= CURRENT_DATE
                AND STORE.FILIA NOT LIKE 'GD%'
    
    LEFT JOIN (SELECT ARTNR, AKTHE, WAKH.VKDAB, WAKH.VKDBI
                FROM WAKP 
                INNER JOIN WAKH 
                ON WAKH.AKTNR = WAKP.AKTNR AND WAKH.VKDBI >= CURRENT_DATE
                ) XC ON XC.ARTNR = MARA.MATNR

    LEFT JOIN TWATT
            ON TWATT.AKTHE = XC.AKTHE AND TWATT.SPRAS = 'E'

    LEFT JOIN WRF_BRANDS_T BRANDT 
            ON BRANDT.BRAND_ID = MARA.BRAND_ID AND BRANDT.LANGUAGE = 'E'
    LEFT JOIN WRF_BRANDS BRAND
            ON BRAND.BRAND_ID = MARA.BRAND_ID

                          /**--Update Region Here**/

        LEFT JOIN (SELECT MATNR, KBETR, STRING_AGG(PLTYP, ',' ORDER BY PLTYP) AS SOURCE
                    FROM A155
                    INNER JOIN KONP ON KONP.KNUMH = A155.KNUMH AND KONP.KSCHL = 'VKP0'
                    WHERE A155.DATBI = '99991231' AND KBETR > 0
                    GROUP BY MATNR, KBETR) A155 ON A155.MATNR = COMP.MATNR 

    LEFT JOIN (SELECT MATNR, KBETR, VKORG
                FROM A073
                INNER JOIN KONP ON KONP.KNUMH = A073.KNUMH AND KONP.KSCHL = 'VKP0'
                WHERE A073.DATBI = '99991231' AND KBETR > 0 AND A073.VKORG = '5998'
                ) A073 ON RIGHT (A073.MATNR, 6) = CASE 
			WHEN COMP.ATTYP = '00' THEN RIGHT(COMP.MATNR, 6)
			WHEN COMP.ATTYP = '01' THEN RIGHT(COMP.MATNR, 6)
			WHEN COMP.ATTYP = '02' THEN LEFT(RIGHT(COMP.MATNR, 9),6)
			WHEN COMP.ATTYP = '12' THEN RIGHT(COMP.MATNR, 6)
		END 


    LEFT JOIN (SELECT DISTINCT MATNR
                FROM EKKO 
                INNER JOIN EKPO ON EKPO.EBELN = EKKO.EBELN
                WHERE EKKO.KDATE >= CURRENT_DATE
            ) AC ON AC.MATNR = MARA.MATNR
        INNER JOIN
	WRF_MATGRP_MD2T CAT ON
		CAT.SPRAS = 'E' AND
		CAT.NODE = LEFT(MARA.MATKL, 4)
        INNER JOIN
	WRF_MATGRP_MD3T CG ON
		CG.SPRAS = 'E' AND
		CG.NODE = LEFT(MARA.MATKL, 6)
        INNER JOIN
	WRF_MATGRP_MD4T SCG ON
		SCG.SPRAS = 'E' AND
		SCG.NODE = LEFT(MARA.MATKL, 8)

    LEFT JOIN BUT000 ON 
            BUT000.PARTNER = LCO.LIFNR 
    LEFT JOIN (SELECT MATNR, STRING_AGG (EAN11, ', ') AS EAN11
                FROM MEAN 
                WHERE MEAN.EANTP NOT IN ('ZZ','Z1') AND MEAN.ZZCOUNTRY = 'AU'
                GROUP BY MATNR) AS MEAN
                ON MEAN.MATNR = COMP.MATNR

    LEFT JOIN (SELECT DISTINCT DISPLAYARTICLE, SALEABLEARTICLE, CALCULATEDPRICEVALUE, CALCULATEDBASEPRICE
                    FROM ZP2M_PCP2_DUEITM
                    WHERE CALCULATEDBASEPRICE <> '' AND CALCULATEDBASEPRICE not LIKE '%c per kg' AND MMSTA = '10' AND RETAILPRICEVALIDTO > CURRENT_DATE AND STATUS = 6 
                        AND CALCULATEDBASEPRICE not LIKE '100c%' AND
                        CALCULATEDBASEPRICE not LIKE '200c%' AND
                        CALCULATEDBASEPRICE not LIKE '150c%' AND
                        CALCULATEDBASEPRICE not LIKE '199c%' AND
                        CALCULATEDBASEPRICE not LIKE '299c%' AND
                        CALCULATEDBASEPRICE not LIKE '399c%' AND
                        CALCULATEDBASEPRICE not LIKE '499c%'                 
            ) Z ON RIGHT(Z.SALEABLEARTICLE,6) = CASE 
			WHEN COMP.ATTYP = '00' THEN RIGHT(COMP.MATNR, 6)
			WHEN COMP.ATTYP = '01' THEN RIGHT(COMP.MATNR, 6)
			WHEN COMP.ATTYP = '02' THEN LEFT(RIGHT(COMP.MATNR, 9),6)
			WHEN COMP.ATTYP = '12' THEN RIGHT(COMP.MATNR, 6)
		END AND Z.CALCULATEDPRICEVALUE = CASE WHEN MARA.MTART = 'Z101' THEN A155.KBETR ELSE A073.KBETR END


WHERE
MARA.MTART IN ('Z100', 'Z101')
AND ((RIGHT(LEFT(MVKE.PRODH, 10),6) IN ('200001', '200005','400001','400005')) OR (LEFT(MVKE.PRODH, 5) != '00002' AND LCO.MATNR IS NOT NULL) OR
(LEFT(MVKE.PRODH, 5) = '00002' AND AC.MATNR IS NOT NULL))
)

SELECT DISTINCT Product_Class,
ARTICLE_TYPE,
SAP_ID,
SELLABLE_ID AS SINGLE_GENERIC,
DISPLAY_ID,
DESCRIPTION,
CBIS_CODE,
VARIANTID AS VARIANT,
VARIANT_NAME AS Variant_Description,
ON_SALE_DATE,
THEME_DESCRIPTION,
Category,
CG,
SCG,
VENDOR_ID,
SUPPLIER_NAME,
SAP_OUTLINE_AGREEMENT,
CONTRACT_NO,
ACTIVE_CONTRACT,
BUYING_DICRECTOR,
BRAND_NAME,
BRAND_TYPE,
RETAIL,
RETAIL_SOURCE,
UNITPRICE,
WEIGHT,
UPC
FROM MAIN M
ORDER BY DISPLAY_ID DESC, VARIANTID ASC
